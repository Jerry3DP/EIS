<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>Easy Input Shaper</title>
  <style>
    .progress-container {
      position: absolute;
      top: 12.5%;
      left: 50%;
      transform: translateX(-50%);
      width: 50%;
    }
    progress {
      width: 100%;
    }
    .progress-label {
      position: absolute;
      font-size: 12px;
      color: #1E9FFF;
      top: -22px;
      left: 50%;
      transform: translateX(-50%);
    }

    .inline-edit {
      display: flex;
      align-items: center;
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
    }
    input[type="text"] {
      margin-right: 10px;
    }
    .shaper-result {
      display: flex;
      justify-content: center;
      align-items: center;
      flex-grow: 1;
    }
    .shaper-result img {
      margin-right: 10px;
      max-width: 40%;
      height: auto;
    }
  </style>
  <script>

      window.onload = function () {
      // Replace "your-websocket-url" with your actual WebSocket URL
        const host = window.location.host;
        const wsAddress = "ws://" + host + "/ws";

        const socket = new WebSocket(wsAddress);

        socket.addEventListener("message", (event) => {
          const data = event.data;
          const [progress, text] = data.split("%");
          updateProgress(parseInt(progress, 10), text);
        });

        function updateProgress(progress, text) {
          const progressBar = document.querySelector("progress");
          const progressLabel = document.querySelector(".progress-label");

          progressBar.value = progress;
          progressLabel.textContent = `${progress}% ${text}`;
        }
    }

  </script>

  <link rel="stylesheet" href="/static/layui.css">
  <style>
    html, body {
      height: 100%;
      margin: 0;
    }
    .layui-side {
      height: 100%;
      position: fixed;
    }
    .main-body {
      background-color: #f2f2f2;
      margin-left: 200px;
      height: 100%;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      position: relative;
    }
  </style>
</head>
<body>
<div class="layui-side layui-bg-black">
  <div class="layui-side-scroll">
    <!-- 左侧导航区域（可配合 layui 已有的垂直导航） -->
    <ul class="layui-nav layui-nav-tree" lay-filter="test">
      <li class="layui-nav-item layui-nav-itemed">
        <a class="" href="javascript:void(0);"  onclick="newTest()">+测试</a>
        <dl class="layui-nav-child">
          {{if .new}}
            <dd><a href="/report/{{.cTime}}">{{.cTimeStr}}</a></dd>
          {{end}}
          {{range .records}}
            <dd><a href="/report/{{.Time}}">{{.Name}}</a></dd>
          {{end}}
        </dl>
      </li>
      <li class="layui-nav-item"><a href="javascript:void(0);" onclick="socketConfig()">接口配置</a></li>
      <li class="layui-nav-item"><a href="javascript:void(0);" onclick="pathConfig()">目录配置</a></li>
	  <li class="layui-nav-item"><a href="https://klipper.club/klipper/t600_p1.html">结果解读</a></li>
	  <li class="layui-nav-item"><a href="https://klipper.club">klipper俱乐部</a></li>
	  <li class="layui-nav-item"><a href="https://github.com/MagicPhoenix/EIS">原作者Github</a></li>
    </ul>
  </div>
</div>

<div class="main-body">
  <div class="progress-container">
    <progress value="100" max="100"></progress>
    <span class="progress-label">100%</span>
  </div>
  <div class="shaper-result">
    <img src="/static/result/{{.cTime}}x.png" alt="X">
    <img src="/static/result/{{.cTime}}y.png" alt="y">
  </div>
  <div class="inline-edit">
    <input type="text" name="name"  autocomplete="off" class="layui-input">
    <button class="layui-btn layui-btn-primary layui-border-black" onclick="submitRename()">重命名</button>
    <button class="layui-btn layui-btn-primary layui-border-black" onclick="del()">删除</button>
  </div>
</div>
<script>
  async function socketConfig() {
    const userInput = prompt("输入接口地址：\n接口地址位于moonraker.conf【klippy_uds_address】后面这串\n例子：/home/biqu/printer_data/comms/klippy.sock");

    if (!userInput || userInput.trim() === "") return alert("无效值");
    const formData = new FormData();
    formData.append("input", userInput);

    try {
      const response = await fetch("/config/socket", {
        method: "POST",
        body: formData,
      });
      if (!response.ok) throw new Error("Error");
      alert("配置成功");
    } catch (error) {
      console.error("Error:", error);
      alert("错误");
    }
  }
  async function pathConfig() {
    const userInput = prompt("输入klipper目录:\nklipper目录就是klipper的安装位置，请自行确认，不同版本位置可能有差别\n例子：/home/biqu/klipper");

    if (!userInput || userInput.trim() === "") return alert("无效值");
    const formData = new FormData();
    formData.append("input", userInput);

    try {
      const response = await fetch("/config/path", {
        method: "POST",
        body: formData,
      });
      if (!response.ok) throw new Error("Error");
      alert("Config Success。");
    } catch (error) {
      console.error("Error:", error);
      alert("Error。");
    }
  }
  function submitRename() {
    const inputValue = document.querySelector('input[name="name"]').value;
    const formData = new FormData();
    formData.append('name', inputValue);
    formData.append('ctime', {{.cTime}});

    fetch('/report/rename', {
      method: 'POST',
      body: formData,
    })
            .then((response) => {
              if (response.ok) {
                alert('重命名成功');
              } else {
                throw new Error('重命名失败');
              }
            })
            .catch((error) => {
              console.error('Error:', error);
              alert('Error: 无法重命名');
            });
  }

  function del() {
    const confirmed = confirm('确定删除？');

    const formData = new FormData();
    formData.append('ctime', {{.cTime}})
    if (confirmed){
      fetch('/report/del', {
        method: 'POST',
        body: formData,
        redirect: 'manual',
      })
    .then((response) => {
        if (response.status === 302) {
          window.location.assign(response.headers.get('Location'))
        } else {
          console.error('错误: 302重定向失败！');
        }
      })
              .catch((error) => {
                console.error('Error:', error);
              });
    }


  }
  function newTest() {
    const confirmed = confirm('确定重新测试？\n注意先要归位，并检查打印机是否已经放置平稳。\n测试结束后手动刷新就能看到图形化结果。');

    if (confirmed) {
      fetch('/newCalibrate', {
        method: 'POST',
      })
              .then((response) => {
                if (response.status === 302) {
                  window.location.assign(response.headers.get('Location'))
                } else {
                  console.error('错误: 302重定向失败！');
                }
              })
              .catch((error) => {
                console.error('Error:', error);
              });
    }

  }



</script>
</body>
</html>
